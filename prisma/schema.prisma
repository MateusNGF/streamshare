generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanoConta {
  free
  pro
  business
}

enum ProviderAuth {
  local
  google
}

enum NivelAcesso {
  owner
  admin
}

enum FrequenciaPagamento {
  mensal
  trimestral
  semestral
  anual
}

enum StatusAssinatura {
  pendente
  ativa
  suspensa
  cancelada
}

enum StatusCobranca {
  pendente
  pago
  atrasado
  cancelado
  estornado
}

enum StatusParticipante {
  ativo
  pendente
  recusado
  bloqueado
  saiu
}

enum StatusConvite {
  pendente
  aceito
  recusado
  expirado
  solicitado
}

enum TipoNotificacaoWhatsApp {
  nova_assinatura
  cobranca_gerada
  cobranca_vencendo
  cobranca_atrasada
  assinatura_suspensa
  pagamento_confirmado
}

enum TipoNotificacao {
  // Participantes
  participante_criado
  participante_editado
  participante_excluido

  // Streamings
  streaming_criado
  streaming_editado
  streaming_excluido

  // Assinaturas
  assinatura_criada
  assinatura_editada
  assinatura_suspensa
  assinatura_cancelada
  assinatura_renovada

  // Cobranças
  cobranca_gerada
  cobranca_confirmada
  cobranca_cancelada

  // Grupos
  grupo_criado
  grupo_editado
  grupo_excluido

  // Configurações
  configuracao_alterada

  // Sistema
  plano_alterado

  // Convites e Solicitações
  solicitacao_participacao_criada
  solicitacao_participacao_aceita
  solicitacao_participacao_recusada
  convite_recebido
  convite_aceito

  // Suporte
  suporte_atualizado
}

enum StatusSuporte {
  pendente
  em_analise
  resolvido
  finalizado
}

model Suporte {
  id        Int           @id @default(autoincrement())
  nome      String
  email     String
  assunto   String
  descricao String        @db.Text
  status    StatusSuporte @default(pendente)
  usuarioId Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  @@map("suporte")
}

//////////////////////////////////////////////////
// MODELS
//////////////////////////////////////////////////

enum MetodoPagamento {
  CREDIT_CARD
  PIX
}

model Conta {
  id    Int        @id @default(autoincrement())
  nome  String?
  email String?    @unique
  plano PlanoConta

  isAtivo          Boolean  @default(true)
  moedaPreferencia String   @default("BRL")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  chavePix         String?

  usuarios       ContaUsuario[]
  grupos         Grupo[]
  participantes  Participante[]
  streamings     Streaming[]
  whatsappConfig WhatsAppConfig?
  notificacoes   Notificacao[]
  convites       Convite[]

  gatewayCustomerId         String? @unique
  gatewaySubscriptionId     String? @unique
  gatewaySubscriptionStatus String?
  gatewayCancelAtPeriodEnd  Boolean @default(false)
  wallet                    Wallet?

  @@map("conta")
}

model Usuario {
  id                Int          @id @default(autoincrement())
  email             String       @unique
  nome              String
  whatsapp          String?
  senhaHash         String?
  provider          ProviderAuth @default(local)
  isAtivo           Boolean      @default(true)
  ultimoLogin       DateTime?
  sessionVersion    Int          @default(1)
  lastIp            String?
  lastUserAgent     String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  termsAcceptedAt   DateTime?
  termsVersion      String?
  privacyAcceptedAt DateTime?
  privacyVersion    String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  contas                ContaUsuario[]
  participantes         Participante[]
  admin                 UsuarioAdmin?
  notificacoes          Notificacao[]
  assinaturasCanceladas Assinatura[]   @relation("CanceladoPor")
  convitesFeitos        Convite[]      @relation("Convidou")
  convitesRecebidos     Convite[]      @relation("Convidado")
  reports               Suporte[]

  @@map("usuario")
}

model ContaUsuario {
  id          Int         @id @default(autoincrement())
  contaId     Int
  usuarioId   Int
  nivelAcesso NivelAcesso @default(admin)
  isAtivo     Boolean     @default(true)

  conta   Conta   @relation(fields: [contaId], references: [id])
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@unique([contaId, usuarioId])
  @@map("conta_usuario")
}

model Grupo {
  id                        Int      @id @default(autoincrement())
  contaId                   Int
  nome                      String
  descricao                 String?
  linkConvite               String   @unique
  permitirEscolhaStreamings Boolean  @default(true)
  isPublico                 Boolean  @default(false)
  isAtivo                   Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  conta      Conta            @relation(fields: [contaId], references: [id])
  streamings GrupoStreaming[]

  @@map("grupo")
}

model StreamingCatalogo {
  id               Int      @id @default(autoincrement())
  nome             String
  categoria        String   @default("video")
  isConteudoAdulto Boolean  @default(false)
  siteOficial      String?
  iconeUrl         String?
  corPrimaria      String   @default("#000000")
  isAtivo          Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  streamings Streaming[]

  @@map("streaming_catalogo")
}

model Streaming {
  id                     Int       @id @default(autoincrement())
  contaId                Int
  streamingCatalogoId    Int
  apelido                String?   @default("")
  valorIntegral          Decimal
  limiteParticipantes    Int
  frequenciasHabilitadas String    @default("mensal,trimestral,semestral,anual")
  publicToken            String    @unique @default(uuid())
  isAtivo                Boolean   @default(true)
  isPublico              Boolean   @default(false)
  deletedAt              DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  conta       Conta                 @relation(fields: [contaId], references: [id])
  catalogo    StreamingCatalogo     @relation(fields: [streamingCatalogoId], references: [id])
  credenciais StreamingCredenciais?
  grupos      GrupoStreaming[]
  assinaturas Assinatura[]
  convites    Convite[]

  @@map("streaming")
}

model StreamingCredenciais {
  id             Int      @id @default(autoincrement())
  streamingId    Int      @unique
  login          String?
  senhaEncrypted String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  streaming Streaming @relation(fields: [streamingId], references: [id], onDelete: Cascade)

  @@map("streaming_credenciais")
}

model GrupoStreaming {
  id          Int     @id @default(autoincrement())
  streamingId Int
  grupoId     Int
  isAtivo     Boolean @default(true)

  streaming Streaming @relation(fields: [streamingId], references: [id])
  grupo     Grupo     @relation(fields: [grupoId], references: [id])

  @@unique([streamingId, grupoId])
  @@map("grupo_streaming")
}

model Participante {
  id             Int                @id @default(autoincrement())
  contaId        Int
  nome           String
  whatsappNumero String?
  cpf            String?
  email          String?
  userId         Int?
  status         StatusParticipante @default(ativo)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  conta        Conta         @relation(fields: [contaId], references: [id])
  usuario      Usuario?      @relation(fields: [userId], references: [id])
  assinaturas  Assinatura[]
  whatsappLogs WhatsAppLog[]

  @@unique([contaId, cpf])
  @@unique([contaId, whatsappNumero])
  @@unique([contaId, userId])
  @@map("participante")
}

model Assinatura {
  id                     Int                 @id @default(autoincrement())
  participanteId         Int
  streamingId            Int
  frequencia             FrequenciaPagamento
  status                 StatusAssinatura    @default(ativa)
  dataInicio             DateTime
  valor                  Decimal
  dataSuspensao          DateTime?
  motivoSuspensao        String?
  dataCancelamento       DateTime?
  motivoCancelamento     String?
  canceladoPorId         Int?
  cobrancaAutomaticaPaga Boolean             @default(false)
  deletedAt              DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  autoRenovacao          Boolean             @default(true)

  participante Participante @relation(fields: [participanteId], references: [id])
  streaming    Streaming    @relation(fields: [streamingId], references: [id])
  canceladoPor Usuario?     @relation("CanceladoPor", fields: [canceladoPorId], references: [id])
  cobrancas    Cobranca[]

  @@map("assinatura")
}

model Cobranca {
  id                   Int              @id @default(autoincrement())
  assinaturaId         Int
  valor                Decimal
  periodoInicio        DateTime
  periodoFim           DateTime
  dataPagamento        DateTime?
  status               StatusCobranca   @default(pendente)
  dataVencimento       DateTime
  comprovanteUrl       String?
  gatewayTransactionId String?
  gatewayProvider      String?
  gatewayId            String?
  metodoPagamento      MetodoPagamento?
  pixQrCode            String?
  pixCopiaECola        String?
  tentativas           Int              @default(0)
  metadataJson         Json?
  deletedAt            DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  assinatura Assinatura @relation(fields: [assinaturaId], references: [id])

  @@unique([assinaturaId, periodoInicio])
  @@map("cobranca")
}

model WhatsAppConfig {
  id      Int @id @default(autoincrement())
  contaId Int @unique

  notificarNovaAssinatura      Boolean @default(true)
  notificarCobrancaGerada      Boolean @default(true)
  notificarCobrancaVencendo    Boolean @default(true)
  notificarCobrancaAtrasada    Boolean @default(true)
  notificarAssinaturaSuspensa  Boolean @default(true)
  notificarPagamentoConfirmado Boolean @default(true)

  diasAvisoVencimento Int     @default(3)
  isAtivo             Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conta Conta         @relation(fields: [contaId], references: [id])
  logs  WhatsAppLog[]

  @@map("whatsapp_config")
}

model WhatsAppLog {
  id             Int  @id @default(autoincrement())
  configId       Int
  participanteId Int?

  tipo          TipoNotificacaoWhatsApp
  numeroDestino String
  mensagem      String                  @db.Text

  enviado    Boolean @default(false)
  erro       String? @db.Text
  providerId String?

  createdAt DateTime @default(now())

  config       WhatsAppConfig @relation(fields: [configId], references: [id])
  participante Participante?  @relation(fields: [participanteId], references: [id])

  @@index([configId, createdAt])
  @@map("whatsapp_log")
}

model Convite {
  id             String        @id @default(uuid())
  email          String
  contaId        Int
  streamingId    Int?
  status         StatusConvite @default(pendente)
  token          String        @unique
  expiresAt      DateTime
  convidadoPorId Int?
  usuarioId      Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  conta        Conta      @relation(fields: [contaId], references: [id])
  streaming    Streaming? @relation(fields: [streamingId], references: [id])
  convidadoPor Usuario?   @relation("Convidou", fields: [convidadoPorId], references: [id])
  usuario      Usuario?   @relation("Convidado", fields: [usuarioId], references: [id])

  @@index([email])
  @@index([usuarioId])
  @@index([contaId, status])
  @@map("convite")
}

model UsuarioAdmin {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @unique
  isAtivo   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@map("usuario_admin")
}

model Parametro {
  id        Int      @id @default(autoincrement())
  chave     String   @unique
  valor     String   @db.Text
  tipo      String   @default("string") // string, number, boolean, json
  descricao String?
  isAtivo   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parametro")
}

model Notificacao {
  id         Int             @id @default(autoincrement())
  contaId    Int
  tipo       TipoNotificacao
  titulo     String
  descricao  String?
  entidadeId Int?
  usuarioId  Int?
  metadata   Json?
  lida       Boolean         @default(false)
  createdAt  DateTime        @default(now())

  conta   Conta    @relation(fields: [contaId], references: [id])
  usuario Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([contaId, createdAt])
  @@index([usuarioId, createdAt])
  @@map("notificacao")
}

enum TransactionType {
  CREDITO_COTA // Entrada: pagamento de participante
  DEBITO_TAXA // Saída: taxa StreamShare
  SAQUE // Saída: saque solicitado pelo Admin
  ESTORNO // Entrada: estorno de saque rejeitado
  CHARGEBACK // Saída: chargeback do gateway
}

enum TransactionStatus {
  PENDENTE
  CONCLUIDO
  FALHA
  CANCELADO
}

enum TipoChavePix {
  CPF
  EMAIL
  TELEFONE
  ALEATORIA
}

model Wallet {
  id              Int           @id @default(autoincrement())
  contaId         Int           @unique
  conta           Conta         @relation(fields: [contaId], references: [id], onDelete: Cascade)
  saldoDisponivel Decimal       @default(0.00) @db.Decimal(10, 2)
  saldoPendente   Decimal       @default(0.00) @db.Decimal(10, 2)
  chavePixSaque   String?
  tipoChavePix    TipoChavePix?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  transacoes WalletTransaction[]
  saques     Saque[]

  @@map("wallet")
}

model WalletTransaction {
  id                Int               @id @default(autoincrement())
  walletId          Int
  wallet            Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  valor             Decimal           @db.Decimal(10, 2)
  tipo              TransactionType
  status            TransactionStatus @default(CONCLUIDO)
  descricao         String
  referenciaGateway String?
  metadataJson      Json?
  createdAt         DateTime          @default(now())

  @@index([walletId, createdAt])
  @@map("wallet_transaction")
}

model Saque {
  id                Int               @id @default(autoincrement())
  walletId          Int
  wallet            Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  valor             Decimal           @db.Decimal(10, 2)
  status            TransactionStatus @default(PENDENTE)
  chavePixDestino   String
  tipoChaveDestino  TipoChavePix
  motivoRejeicao    String?
  transferenciaMpId String?
  comprovanteUrl    String?
  aprovadoPorId     Int?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status, createdAt])
  @@map("saque")
}
